<html>
  <meta charset="UTF-8">
  <title>Design Analysis by VCS</title>
<head>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis-network.min.css" rel="stylesheet" type="text/css"/>
  <style type="text/css">
    #mynetwork {
      width: 700px;
      height: 400px;
      border: 1px solid lightgray;
    }
  </style>
  <script src="design-by-vcs.js"></script>
  <script>
    'use strict';

    function visJsDemo() {
      // create an array with nodes
      var nodes = new vis.DataSet([
        {id: 1, label: 'Node 1'},
        {id: 2, label: 'Node 2'},
        {id: 3, label: 'Node 3'},
        {id: 4, label: 'Node 4'},
        {id: 5, label: 'Node 5'}
      ]);

      // create an array with edges
      var edges = new vis.DataSet([
        {from: 1, to: 3, width: 1},
        {from: 1, to: 2, width: 6},
        {from: 2, to: 4, width: 1},
        {from: 2, to: 5, width: 3},
        {from: 2, to: 3, width: 1},
      ]);

      // create a network
      var container = document.getElementById('mynetwork');
      var data = {
        nodes: nodes,
        edges: edges
      };
      var options = {};
      var network = new vis.Network(container, data, options);
    }

    function displayChanges(hackedGraph) {
      console.log(hackedGraph);

      // TODO: ICM 2020-02-05: Can we use a map transformation?
      const rawNodes = [];
      hackedGraph.nodesByFile.forEach(function (value, key) {
        rawNodes.push({ id: value.id, label: value.name });
      });

      console.log(rawNodes);
      // create an array with nodes
      var nodes = new vis.DataSet(rawNodes);

      // Convert weight to width
      const rawEdges = [];
      hackedGraph.edges.forEach(function (e) {
        rawEdges.push({ from: e.from, to: e.to, width: e.weight });
      });
      console.log(rawEdges);

      // create an array with edges
      var edges = new vis.DataSet(rawEdges);

      // create a network
      var container = document.getElementById('mynetwork');
      var data = {
        nodes: nodes,
        edges: edges
      };
      var options = {};
      var network = new vis.Network(container, data, options);
    }

    const openFile = function (event) {
      const input = event.target;

      const reader = new FileReader();
      reader.onload = function () {
        const text = reader.result;

        const node = document.getElementById('output');
        node.innerText = text;
        const file = input.files[0];
        console.log('File name: ' + file.name + '\n'
            + 'type: ' + file.type + '\n'
            + 'size: ' + file.size + ' bytes\n'
            + 'starts with: ' + text.substr(0, text.indexOf('\n'))
        );

        // `git log` seems to produce Linux line endings, even on Windows,
        // so that makes things simpler to process
        const lines = text.split('\n');
        const hackedGraph = processGitLog(lines);

        // Remove self-links
        // TODO: ICM 2020-02-06: Consider whether this should be done earlier
        // TODO: ICM 2020-02-06: make optional
        hackedGraph.edges = hackedGraph.edges.filter(edge => edge.from !== edge.to);

        visJsDemo();
        displayChanges(hackedGraph);
      };

      reader.readAsText(input.files[0]);
    };
  </script>
</head>
<body>
  <h1>Design Analysis by VCS</h1>

  <p>Load a suitable git log file. The recommended command is based on this
    suggestion from
    <a href="https://github.com/adamtornhill/code-maat">code-maat's <samp>README.md</samp></a>:
  </p>
  <pre><code>
git log --all --numstat --date=short --pretty=format:'--%h--%ad--%aN' --no-renames --after=YYYY-MM-DD
  </code></pre>

  <p>In our case, we will play with whether or not to use
    <samp>--no-renames</samp>, starting <em>with</em> it.
    And we will redirect the output into a suitable text file.
    <strong>And</strong>, we want the total history, at least while we
    experiment.
    Apart from anything else, this will guarantee that we will pick
    up every single in the system.
    So we don't use <samp>--after</samp>.
  </p>
  <pre><code>
git log --all --numstat --date=short --pretty=format:'--%h--%ad--%aN' --no-renames > code-maat--log.txt
  </code></pre>

  <p>We will also experiment with using the <samp>--reverse</samp> option,
    because we're thinking we'll want to process the log in historical order?
  </p>
  <pre><code>
git log --reverse --all --numstat --date=short --pretty=format:'--%h--%ad--%aN' --no-renames > code-maat--log--reversed.txt
  </code></pre>

  <p><strong>Load a file...</strong></p>

  <input type='file' accept='text/plain' onchange='openFile(event)'><br>

  <p><strong>then check the console to see what's happened.</strong></p>

  <div id="mynetwork"></div>

  <pre><code id='output'>
...
  </code></pre>
</body>
</html>
